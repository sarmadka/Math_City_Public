@منفذ_بياني["POST", "/api/contact"]
دالة اتصل_بي(اتصال:مؤشر[بـننف.اتـصال]) {
    عرف صوان: مصفوفة[مـحرف، 2048]؛
    عرف حجم_البيانات: صحيح = بـننف.اقرأ(اتصال، صوان~مؤشر، صوان~حجم)؛
    إذا حجم_البيانات < 0 {
        أرجع_ردا(400، اتصال)؛
        ارجع؛
    }
    عرف نص_جيسون: نـص = نـص(صوان~مؤشر، حجم_البيانات)؛
    عرف جيسون: جـيسون(نص_جيسون)؛
    عرف البريد_الإلكتروني: نـص = جيسون("email")؛
    عرف الاسم: نـص = جيسون("name")؛
    عرف العنوان: نـص = جيسون("title")؛
    عرف المتن: نـص = جيسون("body")؛
    عرف رمز_كابجا: نـص = جيسون("captchatoken")؛
    إذا ليس ريـكابجا.تحقق(إعـدادات.مفتاح_خادم_كابجا، رمز_كابجا) {
        أرجع_ردا(422، اتصال)؛
    } وإلا إذا أرسل_بريدًا_إلكترونيا(البريد_الإلكتروني، الاسم، العنوان، المتن) {
        أرجع_ردا(200، اتصال)؛
    } وإلا {
        أرجع_ردا(500، اتصال)؛
    }
}

دالة أرجع_ردا(رمز: صـحيح، اتصال: مؤشر[بـننف.اتـصال]) {
    بـننف.اطبع(اتصال, "HTTP/1.1 %d error\r\n"، رمز);
    بـننف.اطبع(اتصال, "Content-Type: text/plain\r\n");
    بـننف.اطبع(اتصال, "Cache-Control: no-cache\r\n");
    بـننف.اطبع(اتصال, "Content-Length: %d\r\n\r\n", 0);
    بـننف.اطبع(اتصال, "");
}

صنف مـشهد_الاتصال {
    @حقنة عرف مركب: مـركب؛
    عرف الإشعار: سـندنا[كـتابة]؛
    عرف الاسم: سـندنا[مـدخل]؛
    عرف البريد_الإلكتروني: سـندنا[مـدخل]؛
    عرف العنوان: سـندنا[مـدخل]؛
    عرف المتن: سـندنا[مـدخل_نص]؛
    عرف كابجا: سـندنا[ريـكابجا.كـابجا]؛
    عرف رمز_كابجا: نـص؛
    عرف قيد_الإرسال: ثـنائي = 0؛

    عملية هذا~هيئ() {
        عرف الكائن: سند[هذا_الصنف](هذا)؛
        هذا.المشهد = صـندوق().{
            الطراز.{
                ملء_السطر = مـلء_سطر._بداية_؛
                المحاذاة = مـحاذاة._وسط_؛
                العرض = مـسافة.مئوي(100) - مـسافة.نقاط(30)؛
                الطول = مـسافة.مئوي(100) - مـسافة.نقاط(60)؛
                الإظهار = إظـهار._مرن_؛
                النسق = نـسق._عمود_؛
                الهامش = مـسافة4.نقاط(5)؛
            }؛
            الطراز(">مدخل").{
                العرض = مـسافة.مئوي(100)؛
                نصف_قطر_الإطار = مـسافة4.نقاط(5)؛
                الهامش = مـسافة4.نقاط(5)؛
                طراز_الإطار = طـراز_إطار._مستمر_؛
                الخلفية = خـلفية(لـون("fff"))؛
                لون_الإطار = لـون("f0e4db")؛
                لون_الخط = لـون(0، 0، 0)؛
                حجم_الخط = مـسافة.نقاط(14)؛
                طراز_الآوتلاين = طـراز_إطار._بلا_؛
            }؛
            الطراز({ ">مدخل"، مـحدد_حالة._بؤرة_ }).{
                لون_الإطار = لـون(0، 0، 0)؛
            }؛
            الطراز(">مدخل_نص").{
                العرض = مـسافة.مئوي(100)؛
                المرونة = مـرونة(1)؛
                نصف_قطر_الإطار = مـسافة4.نقاط(5)؛
                الهامش = مـسافة4.نقاط(5)؛
                طراز_الإطار = طـراز_إطار._مستمر_؛
                الخلفية = خـلفية(لـون("fff"))؛
                لون_الإطار = لـون("f0e4db")؛
                لون_الخط = لـون(0، 0، 0)؛
                حجم_الخط = مـسافة.نقاط(14)؛
                طراز_الآوتلاين = طـراز_إطار._بلا_؛
            }؛
            الطراز({ ">مدخل_نص"، مـحدد_حالة._بؤرة_ }).{
                لون_الإطار = لـون(0، 0، 0)؛
            }؛
            الطراز(">إرسال").{
                العرض = مـسافة.نقاط(50)؛
                المؤشر = مـؤشر._سبابة_؛
                الهامش = مـسافة4.نقاط(5)؛
            }؛
            الطراز(">إشعار_حدث").{
                العرض = مـسافة.مئوي(100)؛
            }؛
            الطراز(">إشعار_خطأ").{
                العرض = مـسافة.مئوي(100)؛
                لون_الخط = لـون(128، 50، 50)؛
            }؛
            الطراز(">إشعار_نجاح").{
                العرض = مـسافة.مئوي(100)؛
                لون_الخط = لـون(50، 128، 50)؛
            }؛
            أضف_فروع({
                كـتابة().{
                    الكائن.الإشعار = هذا؛
                }،
                مـدخل().{
                    الكائن.الاسم = هذا؛
                    قيمة_وصفية = نـص("الاسم")؛
                    اسم_الفئة = نـص("مدخل")؛
                },
                مـدخل().{
                    الكائن.البريد_الإلكتروني = هذا؛
                    قيمة_وصفية = نـص("البريد الإلكتروني")؛
                    اسم_الفئة = نـص("مدخل")؛
                },
                مـدخل().{
                    الكائن.العنوان = هذا؛
                    قيمة_وصفية = نـص("العنوان")؛
                    اسم_الفئة = نـص("مدخل")؛
                },
                مـدخل_نص().{
                    الكائن.المتن = هذا؛
                    اسم_الفئة = نـص("مدخل_نص")؛
                },
            })؛
            تجهيز_الكابجا.ثم[صـحيح](مغلفة (صـحيح، سند[مـؤجلات.مـؤجلة[صـحيح]]) {
                هذا.أضف_فروع({
                    ريـكابجا.كـابجا(نـص(سلسلة_محارف_من_متغير[إعـدادات.مفتاح_واجهة_كابجا])).{
                        الكائن.كابجا = هذا؛
                    }،
                    صـورة().{
                        الرابط = نـص("/رسوم/إرسال.svg")؛
                        اسم_الفئة = نـص("إرسال")؛
                        عند_الضغط.اربط(مغلفة (سند[ودجـة]، سند[صـحيح]) {
                            إذا الكائن.قيد_الإرسال ارجع؛
                            الكائن.رمز_كابجا = الكائن.كابجا.هات_الإجابة()؛
                            الكائن.أرسل()؛
                        })؛
                    }
                })؛
            })؛
        }؛
    }

    عرف _إرسال_: "POST"؛
    عرف _المسار_: "/api/contact"؛
    عرف _ترويسة_صنف_بيانات_نصي_: "Content-Type: application/json"؛

    عملية هذا.أرسل() {
        عرف الاسم: نـص = هذا.الاسم.هات_النص().شذب()؛
        عرف البريد_الإلكتروني: نـص = هذا.البريد_الإلكتروني.هات_النص().شذب()؛
        عرف العنوان: نـص = هذا.العنوان.هات_النص().شذب()؛
        عرف المتن: نـص = هذا.المتن.هات_النص().شذب()؛
        إذا الاسم == "" أو البريد_الإلكتروني == "" أو العنوان == "" أو المتن == "" {
            هذا.الإشعار.النص = نـص("يُرجى إدخال جميع الحقول")؛
            هذا.الإشعار.اسم_الفئة = نـص("إشعار_خطأ")؛
            ارجع؛
        }

        إذا طابق_نمطا(البريد_الإلكتروني، "[a-zA-Z0-9._+-]+@[a-zA-Z0-9_.-]+\\.[a-zA-Z0-9]+").هات_الطول() == 0 {
            هذا.الإشعار.النص = نـص("عنوان البريد الإلكتروني غير صالح")؛
            هذا.الإشعار.اسم_الفئة = نـص("إشعار_خطأ")؛
            ارجع؛
        }

        إذا هذا.رمز_كابجا == "" {
            هذا.الإشعار.النص = نـص("يجب التحقق من أنك لست روبوتًا")؛
            هذا.الإشعار.اسم_الفئة = نـص("إشعار_خطأ")؛
            ارجع؛
        }

        عرف جيسون: نـص = نـص.املأ(
            ‏"{\"name\": \"%s\", \"email\": \"%s\", \"title\": \"%s\", \"body\": \"%s\", \"captchatoken\": \"%s\"}"،
            رمّز_إكسمل(الاسم).صوان،
            رمّز_إكسمل(البريد_الإلكتروني).صوان،
            رمّز_إكسمل(العنوان).صوان،
            رمّز_إكسمل(المتن).صوان،
            هذا.رمز_كابجا.صوان
        )؛
        هذا.قيد_الإرسال = 1؛
        هذا.الإشعار.النص = نـص("قيد الإرسال")؛
        هذا.الإشعار.اسم_الفئة = نـص("إشعار_حدث")؛
        أرسل_نداء(
            _إرسال_، _المسار_، _ترويسة_صنف_بيانات_نصي_، جيسون، 10000، مغلفة(جسون: جـيسون) {
                هذا.قيد_الإرسال = 0؛
                إذا جسون("eventData")("status")~مثل[صـحيح] == 200 {
                    هذا.الإشعار.النص = نـص("أُرسلت الرسالة بنجاح")؛
                    هذا.الإشعار.اسم_الفئة = نـص("إشعار_نجاح")؛
                } وإلا {
                    هذا.الإشعار.النص = نـص("حدث خطأ غير متوقع")؛
                    هذا.الإشعار.اسم_الفئة = نـص("إشعار_خطأ")؛
                }
            }
        )؛
    }

    عملية هذا_الصنف (): سـندنا[مـشهد_الاتصال] {
        أرجع سـندنا[مـشهد_الاتصال]().{ احجز()~هيئ() }؛
    }
}
