صنف نـقش_متعدد {
    //==========
    // المتغيرات

    عرف نقوش: مـصفوفة[مؤشر[طـوب.نـقش]]؛
    عرف طول: صـحيح؛
    عرف عرض: صـحيح؛

    //=========
    // العمليات

    عملية هذا~هيئ() {}
    عملية هذا~هيئ(بادئة_الملف: نـص) هذا.هيئ(بادئة_الملف، 0)؛
    عملية هذا~هيئ(ع: صحيح، ط: صحيح) هذا.هيئ(ع، ط)؛
    عملية هذا~هيئ(ع: صحيح، ط: صحيح، حالات: صحيح) هذا.هيئ(ع، ط، حالات)؛
    عملية هذا~هيئ(سطح: مؤشر[طـوب.سـطح]) هذا.هيئ(سطح)؛
    عملية هذا~أتلف() {
        هذا.حرر()؛
    }

    //=======
    // الدالات

    عملية هذا.هيئ (بادئة_الملف: نـص، تحجيم: صـحيح): سـندنا[مـؤجلات.مـؤجلة[صـحيح]] {
        هذا.حرر()؛
        عرف ن: صحيح = 0؛
        بينما 1 {
            عرف اسم_الملف: نـص(بادئة_الملف + "-" + ن + ".png")؛
            إذا !نـم.يوجد(اسم_الملف) اقطع؛
            عرف نقش: مؤشر[طـوب.نـقش] = طـوب.صـورة.حمل_نقش(الرسام، اسم_الملف)؛
            إذا نقش == 0 {
                طـرفية.اطبع("فشل تحميل النقش %s\ج"، اسم_الملف.صوان)؛
                نـظام.اخرج(1)؛
            }؛
            هذا.نقوش.أضف(نقش)؛
            ++ن؛
        }؛
        إذا هذا.نقوش.هات_الطول() == 0 {
            طـرفية.اطبع("فشل تحميل النقش %s\ج"، بادئة_الملف.صوان)؛
            نـظام.اخرج(1)؛
        }
        طـوب.نـقش.استفهم(هذا.نقوش(0)، 0، 0، هذا.عرض~مؤشر، هذا.طول~مؤشر)؛
        إذا تحجيم != 0 {
            هذا.عرض *= تحجيم؛
            هذا.طول *= تحجيم؛
        }
        أرجع مـؤجلات.مـؤجلة[صحيح].أنشئ().{ قرر(0) }؛
    }

    عملية هذا.هيئ_مفرد (اسم_الملف: نـص، تحجيم: صـحيح): سـندنا[مـؤجلات.مـؤجلة[صـحيح]] {
        هذا.حرر()؛
        عرف نقش: مؤشر[طـوب.نـقش] = 0؛
        إذا نـم.يوجد(اسم_الملف) { نقش = طـوب.صـورة.حمل_نقش(الرسام، اسم_الملف) }
        إذا نقش == 0 {
            طـرفية.اطبع("فشل تحميل النقش %s\ج"، اسم_الملف.صوان)؛
            نـظام.اخرج(1)؛
        }؛
        هذا.نقوش.أضف(نقش)؛
        طـوب.نـقش.استفهم(هذا.نقوش(0)، 0، 0، هذا.عرض~مؤشر، هذا.طول~مؤشر)؛
        إذا تحجيم != 0 {
            هذا.عرض *= تحجيم؛
            هذا.طول *= تحجيم؛
        }
        أرجع مـؤجلات.مـؤجلة[صحيح].أنشئ().{ قرر(0) }؛
    }

    عملية هذا.هيئ (ع: صحيح، ط: صحيح) {
        هذا.هيئ(ع، ط، 1)؛
    }

    عملية هذا.هيئ (ع: صحيح، ط: صحيح، حالات: صحيح) {
        هذا.حرر()؛
        بينما حالات-- > 0 {
            عرف نقش: مؤشر[طـوب.نـقش] = طـوب.نـقش.أنشئ(الرسام، طـوب.نـسق._حخزش8888_، طـوب.نـقش.ولـوج._مرسم_، ع، ط)؛
            إذا نقش == 0 {
                طـرفية.اطبع("فشل إنشاء النقش.\ج")؛
                نـظام.اخرج(1)؛
            }
            طـوب.نـقش.عين_نمط_المزج(نقش، طـوب.نـمط_المزج._مزج_)؛
            هذا.نقوش.أضف(نقش)؛
        }
        هذا.عرض = ع؛
        هذا.طول = ط؛
    }

    عملية هذا.هيئ (سطح: مؤشر[طـوب.سـطح]) {
        هذا.حرر()؛
        عرف نقش: مؤشر[طـوب.نـقش] = طـوب.نـقش.أنشئ(الرسام، سطح)؛
        إذا نقش == 0 {
            طـرفية.اطبع("فشل إنشاء النقش.\ج")؛
            نـظام.اخرج(1)؛
        }
        طـوب.نـقش.عين_نمط_المزج(نقش، طـوب.نـمط_المزج._مزج_)؛
        هذا.نقوش.أضف(نقش)؛
        طـوب.نـقش.استفهم(هذا.نقوش(0)، 0، 0، هذا.عرض~مؤشر، هذا.طول~مؤشر)؛
    }

    عملية هذا.حرر() {
        عرف ن: صحيح؛
        لكل ن = 0، ن < هذا.نقوش.هات_الطول()، ++ن {
            طـوب.نـقش.أتلف(هذا.نقوش(ن))؛
        }
        هذا.نقوش.فرّغ()؛
    }

    عملية هذا.أمهيأ(): ثـنائي {
        أرجع هذا.نقوش.هات_الطول() > 0؛
    }

    عملية هذا.عدد_الحالات: صـحيح {
        ارجع هذا.نقوش.هات_الطول()؛
    }

    عملية هذا.اطمغ (س: صحيح، ص: صحيح، ش: صحيح، ع: صحيح) {
        عرف مستطيل: طـوب.مـستطيل(س، ص، هذا.عرض، هذا.طول)؛
        طـوب.نـقش.غير_الشفافية(هذا.نقوش(ع)، ش)؛
        طـوب.رسـام.انسخ(الرسام، هذا.نقوش(ع)، 0، مستطيل~مؤشر)؛
    }
}

