@منفذ_بياني["GET", "/api/getframecount"]
دالة هات_عدد_حالات_الملصق(اتصال:مؤشر[بـننف.اتـصال]) {
    عرف العدد: صـحيح = 0؛
    عرف المعطى: مـؤشر_محارف = بـننف.هات_معلومات_الطلب(اتصال)~محتوى.نص_الاستعلام؛
    إذا المعطى != 0 {
        عرف بادئة_الملف: نـص = شـبكة.فك_عنوانيا(المعطى)؛
        بينما 1 {
            عرف اسم_الملف: نـص(بادئة_الملف + "-" + العدد + ".png")؛
            إذا !نـم.يوجد(اسم_الملف) اقطع؛
            ++العدد؛
        }
    } وإلا {
        طـرفية.اطبع("getframecount: خطأ في بيانات الطلب.\ج")؛
    }

    عرف صوان: مصفوفة[مـحرف، 2048]؛
    نـص.عين(صوان~مؤشر، "%d"، العدد)؛
    بـننف.اطبع(اتصال, "HTTP/1.1 200 success\r\n")؛
    بـننف.اطبع(اتصال, "Content-Type: text/plain\r\n")؛
    بـننف.اطبع(اتصال, "Cache-Control: no-cache\r\n")؛
    بـننف.اطبع(اتصال, "Location: %s\r\n", "/profile")؛
    بـننف.اطبع(اتصال, "Content-Length: %d\r\n\r\n", نـص.هات_الطول(صوان~مؤشر))؛
    بـننف.اطبع(اتصال, صوان~مؤشر)؛
}

صنف نـقش_متعدد {
    //==========
    // المتغيرات

    عرف نقوش: مـصفوفة[سـندنا[مـورد_صورة]]؛
    عرف طول: صـحيح؛
    عرف عرض: صـحيح؛

    //=========
    // العمليات

    عملية هذا~هيئ() {}
    عملية هذا~هيئ(بادئة_الملف: نـص) هذا.هيئ(بادئة_الملف، 0)؛
    عملية هذا~هيئ(ع: صحيح، ط: صحيح) هذا.هيئ(ع، ط)؛
    عملية هذا~هيئ(ع: صحيح، ط: صحيح، حالات: صحيح) هذا.هيئ(ع، ط، حالات)؛
    عملية هذا~أتلف() {
        هذا.حرر()؛
    }

    //=======
    // الدالات

    عملية هذا.هيئ (بادئة_الملف: نـص، تحجيم: صـحيح): سـندنا[مـؤجلات.مـؤجلة[صـحيح]] {
        أرجع هذا.حمل(بادئة_الملف، تحجيم).اقبض(مغلفة (خ: سـندنا[خـطأ]، م: سند[مـؤجلات.مـؤجلة_قبض[صـحيح]]) {
            م.أعد(اعرض_نافذة_إعادة_المحاولة().ثم[صـحيح](مغلفة (صـحيح، م2: سند[مـؤجلات.مـؤجلة[صـحيح]]) {
                م2.قرر(هذا.حمل(بادئة_الملف، تحجيم))؛
            }))؛
        })؛
    }

    عملية هذا.حمل(بادئة_الملف: نـص، تحجيم: صـحيح): سـندنا[مـؤجلات.مـؤجلة[صـحيح]] {
        هذا.حرر()؛
        عرف _إرسال_: "GET"؛
        عرف _المسار_: "/api/getframecount"؛
        عرف _ترويسة_صنف_بيانات_نصي_: "Content-Type: application/text"؛
        أرجع أرسل_نداء(
            _إرسال_، نـص(_المسار_) + "?" + بادئة_الملف، _ترويسة_صنف_بيانات_نصي_، 0، 10000
        ).ثم[صـحيح](مغلفة (جيسون: جـيسون، م: سند[مـؤجلات.مـؤجلة[صـحيح]]) {
            عرف مؤجلات: مـصفوفة[سـندنا[مـؤجلات.مـؤجلة[صـحيح]]]؛
            عرف العدد: صـحيح = نـص.اقرأ_صحيح(جيسون("eventData")("body"))؛
            إذا العدد == 0 {
                عرف رسالة_خطأ: نـص = نـص("فشل تحميل النقش ") + بادئة_الملف؛
                اكتب_في_الطرفية(رسالة_خطأ)؛
                م.ارفض(خـطأ_عام.أنشئ(نـص("سيف_تحميل_نقش")، رسالة_خطأ))؛
                ارجع؛
            }
            عرف ع: صـحيح؛
            لكل ع = 0، ع < العدد، ++ع {
                عرف نقش: سـندنا[مـورد_صورة]؛
                نقش.أنشئ()؛
                هذا.نقوش.أضف(نقش)؛
                مؤجلات.أضف(نقش.حمل(بادئة_الملف + "-" + ع + ".png"))؛
            }
            م.قرر(مـؤجلات.مـؤجلة[صـحيح].الكل(مؤجلات).تجاهل_النتيجة())؛
        }).ثم[صـحيح](مغلفة (صـحيح، م: سند[مـؤجلات.مـؤجلة[صـحيح]]) {
            عرف أبعاد: أبـعاد = هذا.نقوش(0).هات_الأبعاد()؛
            إذا تحجيم == 0 {
                هذا.عرض = أبعاد.عرض؛
                هذا.طول = أبعاد.طول؛
            } وإلا {
                هذا.عرض = أبعاد.عرض * تحجيم؛
                هذا.طول = أبعاد.طول * تحجيم؛
            }
            م.قرر(0)؛
        })؛
    }

    عملية هذا.هيئ_مفرد (اسم_الملف: نـص، تحجيم: صـحيح): سـندنا[مـؤجلات.مـؤجلة[صـحيح]] {
        أرجع هذا.حمل_مفرد(اسم_الملف، تحجيم).اقبض(مغلفة (خ: سـندنا[خـطأ]، م: سند[مـؤجلات.مـؤجلة_قبض[صـحيح]]) {
            م.أعد(اعرض_نافذة_إعادة_المحاولة().ثم[صـحيح](مغلفة (صـحيح، م2: سند[مـؤجلات.مـؤجلة[صـحيح]]) {
                م2.قرر(هذا.حمل_مفرد(اسم_الملف، تحجيم))؛
            }))؛
        })؛
    }

    عملية هذا.حمل_مفرد (اسم_الملف: نـص، تحجيم: صـحيح): سـندنا[مـؤجلات.مـؤجلة[صـحيح]] {
        هذا.حرر()؛
        عرف نقش: سـندنا[مـورد_صورة]؛
        نقش.أنشئ()؛
        هذا.نقوش.أضف(نقش)؛
        أرجع نقش.حمل(اسم_الملف)
            .ثم[صـحيح](مغلفة (صـحيح، م: سند[مـؤجلات.مـؤجلة[صـحيح]]) {
                عرف أبعاد: أبـعاد = هذا.نقوش(0).هات_الأبعاد()؛
                إذا تحجيم == 0 {
                    هذا.عرض = أبعاد.عرض؛
                    هذا.طول = أبعاد.طول؛
                } وإلا {
                    هذا.عرض = أبعاد.عرض * تحجيم؛
                    هذا.طول = أبعاد.طول * تحجيم؛
                }
                م.قرر(0)؛
            })؛
    }

    عملية هذا.هيئ (ع: صحيح، ط: صحيح) {
        هذا.هيئ(ع، ط، 1)؛
    }

    عملية هذا.هيئ (ع: صحيح، ط: صحيح، حالات: صحيح) {
        هذا.حرر()؛
        بينما حالات-- > 0 {
            عرف نقش: سـندنا[مـورد_صورة]؛
            نقش.أنشئ()؛
            هذا.نقوش.أضف(نقش)؛
        }
        هذا.عرض = ع؛
        هذا.طول = ط؛
    }

    عملية هذا.حرر() {
        هذا.نقوش.فرّغ()؛
    }

    عملية هذا.أمهيأ(): ثـنائي {
        أرجع هذا.نقوش.هات_الطول() > 0؛
    }

    عملية هذا.عدد_الحالات: صـحيح {
        ارجع هذا.نقوش.هات_الطول()؛
    }

    عملية هذا.اطمغ (س: صحيح، ص: صحيح، ش: صحيح، ع: صحيح) {
        إذا ع >= هذا.نقوش.هات_الطول() أو هذا.نقوش(ع).معرف == 0 ارجع؛
        المرسم.ارسم_صورة(هذا.نقوش(ع)، س، ص، هذا.عرض، هذا.طول، ش ÷ 255.0، 0)؛
    }
}
