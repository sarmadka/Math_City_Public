صنف صـوت {
    //==========
    // المتغيرات

    @مشترك عرف الأصوات: مـصفوفة[سند[صـوت]]؛
    عرف اسم_الملف: نـص؛
    عرف الصوت: سـندنا[مـورد_صوت]؛
    عرف المؤقت: صـحيح_متكيف = 0؛
    عرف الاستئناف_مطلوب: ثـنائي = 0؛

    //=========
    // العمليات

    عملية هذا~هيئ() {
        الأصوات.أضف(هذا)؛
    }
    عملية هذا~هيئ(اسم_الملف: نـص) {
        الأصوات.أضف(هذا)؛
        هذا.هيئ(اسم_الملف)؛
    }
    عملية هذا~هيئ(ص: سند[صـوت]) {
        الأصوات.أضف(هذا)؛
        هذا.اسم_الملف = ص.اسم_الملف؛
        هذا.الصوت = ص.الصوت؛
    }
    عملية هذا~هيئ(صوت: سـندنا[مـورد_صوت]) {
        الأصوات.أضف(هذا)؛
        هذا.الصوت = صوت؛
    }
    عملية هذا~أتلف() {
        عرف ن: صحيح؛
        لكل ن = 0، ن < الأصوات.هات_الطول()، ++ن {
            إذا الأصوات(ن)~مؤشر == هذا~مؤشر {
                الأصوات.أزل(ن)؛
                اقطع؛
            }
        }
        هذا.حرر()؛
    }
    عملية هذا = سند[صـوت] {
        هذا.حرر()؛
        هذا.اسم_الملف = قيمة.اسم_الملف؛
        هذا.الصوت = قيمة.الصوت؛
    }

    //=======
    // الدالات

    عملية هذا.هيئ (اسم_الملف: نـص): سـندنا[مـؤجلات.مـؤجلة[صـحيح]] {
        أرجع هذا.حمل_الصوت(اسم_الملف).اقبض(مغلفة (خ: سـندنا[خـطأ]، م: سند[مـؤجلات.مـؤجلة_قبض[صـحيح]]) {
                م.أعد(اعرض_نافذة_إعادة_المحاولة().ثم[صـحيح](مغلفة (صـحيح، م2: سند[مـؤجلات.مـؤجلة[صـحيح]]) {
                    م2.قرر(هذا.حمل_الصوت(اسم_الملف))؛
                }))؛
            })؛
    }

    عملية هذا.حمل_الصوت (اسم_الملف: نـص): سـندنا[مـؤجلات.مـؤجلة[صـحيح]] {
        عرف صوت: سـندنا[مـورد_صوت]؛
        صوت.أنشئ()؛
        أرجع صوت.حمل(اسم_الملف)
            .ثم[صـحيح](مغلفة (صـحيح، م: سند[مـؤجلات.مـؤجلة[صـحيح]]) {
                هذا.حرر()؛
                هذا.اسم_الملف = اسم_الملف؛
                هذا.الصوت = صوت؛
                م.قرر(0)؛
            })؛
    }

    عملية هذا.حرر() {
        هذا.أوقف(0)؛
        هذا.الصوت.حرر()؛
        هذا.اسم_الملف = ""؛
    }

    عملية هذا.شغل (كرر: ثنائي) {
        إذا هذا.الصوت.أهو_عدم() ارجع؛
        هذا.الصوت.الجهارة = 1.0؛
        هذا.ألغ_مؤقت_الجهارة()؛
        هذا.الصوت.شغل(كرر)؛
    }

    عملية هذا.أوقف (مدة: صحيح) {
        إذا هذا.الصوت.أهو_عدم() ارجع؛
        هذا.ألغ_مؤقت_الجهارة()؛
        إذا هذا.المؤقت != 0 {
            أوقف_المؤقت_المتكرر(هذا.المؤقت)؛
            هذا.المؤقت = 0؛
        }
        إذا مدة <= 20 هذا.الصوت.أوقف()
        وإلا {
            هذا.المؤقت = ابدأ_المؤقت_المتكرر(20000، مغلفة (جـيسون) {
                عرف جهارة: عـائم = هذا.الصوت.الجهارة - 20.0 ÷ مدة؛
                إذا جهارة > 0 هذا.الصوت.الجهارة = جهارة
                وإلا {
                    هذا.الصوت.أوقف()؛
                    هذا.ألغ_مؤقت_الجهارة()؛
                }
            })؛
        }
    }

    عملية هذا.أمشتغل (): ثنائي {
        إذا هذا.الصوت.أهو_عدم() أرجع 0؛
        أرجع هذا.الصوت.أمشتغل()؛
    }

    عملية هذا.ألغ_مؤقت_الجهارة() {
        إذا هذا.المؤقت != 0 {
            أوقف_المؤقت_المتكرر(هذا.المؤقت)؛
            هذا.المؤقت = 0؛
        }
    }

    عملية هذا.ألبث_إن_وجب() {
        إذا هذا.أمشتغل() {
            هذا.الاستئناف_مطلوب = 1؛
            هذا.الصوت.ألبث()؛
        }
    }

    عملية هذا.استأنف_إن_وجب() {
        إذا هذا.الاستئناف_مطلوب {
            هذا.الاستئناف_مطلوب = 0؛
            هذا.الصوت.استأنف()؛
        }
    }

    دالة ألبث_جميع_الأصوات {
        عرف ن: صـحيح؛
        لكل ن = 0، ن < الأصوات.هات_الطول()، ++ن {
            الأصوات(ن).ألبث_إن_وجب()؛
        }
    }

    دالة استأنف_جميع_الأصوات {
        عرف ن: صـحيح؛
        لكل ن = 0، ن < الأصوات.هات_الطول()، ++ن {
            الأصوات(ن).استأنف_إن_وجب()؛
        }
    }
}
